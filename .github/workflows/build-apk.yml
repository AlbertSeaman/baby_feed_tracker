name: æ„å»º Android APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  NODE_VERSION: '18'

jobs:
  build-android:
    name: æ„å»º APK
    runs-on: ubuntu-latest
    timeout-minutes: 30  # å¢åŠ è¶…æ—¶è®¾ç½®
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Node.js ç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        npm ci
        npm install -g eas-cli
        
    - name: é…ç½® Expo å’Œ EAS é¡¹ç›®
      env:
        EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      run: |
        echo "=== éªŒè¯ç¯å¢ƒ ==="
        eas whoami || { echo "âŒ Expo è®¤è¯å¤±è´¥"; exit 1; }
        
        echo "=== æ£€æŸ¥é¡¹ç›®é…ç½® ==="
        if [ ! -f "app.json" ]; then
          echo "âŒ é”™è¯¯ï¼šç¼ºå°‘ app.json æ–‡ä»¶"
          exit 1
        fi
        
        if [ ! -f "eas.json" ]; then
          echo "åˆ›å»ºåŸºç¡€ EAS é…ç½®..."
          echo '{"cli":{"version":">=6.0.0","appVersionSource":"remote"},"build":{"production":{}}}' > eas.json
        fi
        
    - name: æäº¤äº‘ç«¯æ„å»ºä»»åŠ¡å¹¶ç­‰å¾…å®Œæˆ
      env:
        EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      id: build-step
      run: |
        echo "=== æäº¤ Android æ„å»ºä»»åŠ¡åˆ° EAS ==="
        
        # æäº¤æ„å»ºï¼Œå¹¶ç­‰å¾…å®Œæˆ
        BUILD_OUTPUT=$(eas build --platform android --profile production --non-interactive --wait 2>&1)
        echo "$BUILD_OUTPUT"
        
        # ä»è¾“å‡ºä¸­æå–æ„å»ºID
        BUILD_ID=$(echo "$BUILD_OUTPUT" | grep -o "builds/[a-f0-9-]*" | head -1 | cut -d'/' -f2)
        if [ -n "$BUILD_ID" ]; then
          echo "æ„å»ºID: $BUILD_ID"
          echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
        fi
        
        # ä»è¾“å‡ºä¸­æå–ç›´æ¥ä¸‹è½½é“¾æ¥ï¼ˆæ”¹è¿›çš„æå–ï¼‰
        APK_URL=$(echo "$BUILD_OUTPUT" | grep -o "https://expo\.dev/artifacts/eas/[a-zA-Z0-9]*\.apk" | head -1)
        if [ -z "$APK_URL" ]; then
          APK_URL=$(echo "$BUILD_OUTPUT" | grep "Android app:" | grep -o "https://[^ ]*\.apk" | head -1)
        fi
        
        if [ -n "$APK_URL" ]; then
          echo "APKç›´æ¥ä¸‹è½½é“¾æ¥: $APK_URL"
          echo "apk_url=$APK_URL" >> $GITHUB_OUTPUT
        fi
        
        # æ£€æŸ¥æ˜¯å¦çœŸçš„æ„å»ºæˆåŠŸ
        if echo "$BUILD_OUTPUT" | grep -q "Build finished"; then
          echo "âœ… æ„å»ºä»»åŠ¡å·²å®Œæˆï¼"
        else
          echo "âš ï¸  æ„å»ºå¯èƒ½æœªå®Œæˆ"
        fi
        
    - name: ä¸‹è½½ APK æ–‡ä»¶
      run: |
        echo "=== ä¸‹è½½æ„å»ºå¥½çš„ APK ==="
        
        APK_URL="${{ steps.build-step.outputs.apk_url }}"
        
        if [ -n "$APK_URL" ]; then
          echo "ä»ç›´æ¥é“¾æ¥ä¸‹è½½: $APK_URL"
          # æ·»åŠ é‡è¯•å’Œè¿›åº¦æ˜¾ç¤º
          curl -L --retry 3 --retry-delay 5 --progress-bar "$APK_URL" -o ./baby-feeding-tracker.apk
          
          if [ -f "./baby-feeding-tracker.apk" ]; then
            FILE_SIZE=$(stat -c%s "./baby-feeding-tracker.apk")
            if [ "$FILE_SIZE" -gt 1000000 ]; then  # å¤§äº1MBæ‰è®¤ä¸ºæœ‰æ•ˆ
              echo "âœ… APK ä¸‹è½½æˆåŠŸï¼å¤§å°: $((FILE_SIZE/1024/1024))MB"
              ls -lh ./baby-feeding-tracker.apk
            else
              echo "âŒ ä¸‹è½½çš„æ–‡ä»¶å¤ªå°ï¼Œå¯èƒ½ä¸å®Œæ•´"
              rm -f ./baby-feeding-tracker.apk
            fi
          else
            echo "âŒ ä¸‹è½½å¤±è´¥ï¼Œæ–‡ä»¶æœªåˆ›å»º"
          fi
        else
          echo "âš ï¸  æ²¡æœ‰æ‰¾åˆ°APKä¸‹è½½é“¾æ¥"
          echo "è¯·è®¿é—® Expo æ§åˆ¶å°æ‰‹åŠ¨ä¸‹è½½ï¼š"
          echo "https://expo.dev/accounts/AlbertSeaman/projects/baby-feed-tracker/builds"
        fi
        
    - name: ä¸Šä¼  APK ä¾›ä¸‹è½½
      if: success() && hashFiles('./baby-feeding-tracker.apk') == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: baby-feeding-tracker-apk
        path: ./baby-feeding-tracker.apk
        retention-days: 90
        
    - name: æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
      if: always()
      run: |
        echo "=== æ„å»ºç»“æœ ==="
        if [ "${{ job.status }}" = "success" ]; then
          echo "ğŸ‰ æ„å»ºæµç¨‹å®Œæˆï¼"
          echo ""
          echo "ä¸‹è½½ APK æ–¹å¼ï¼š"
          echo "1. åœ¨æ­¤é¡µé¢åº•éƒ¨çš„ 'Artifacts' åŒºåŸŸä¸‹è½½"
          if [ -n "${{ steps.build-step.outputs.apk_url }}" ]; then
            echo "2. ç›´æ¥é“¾æ¥ï¼š${{ steps.build-step.outputs.apk_url }}"
          fi
          echo "3. Expo æ§åˆ¶å°ï¼šhttps://expo.dev/accounts/AlbertSeaman/projects/baby-feed-tracker/builds"
        else
          echo "âš ï¸  æ„å»ºè¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜"
          echo "è¯·æ£€æŸ¥é”™è¯¯æ—¥å¿—å¹¶é‡è¯•"
        fi
