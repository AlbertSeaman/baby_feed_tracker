name: Build and Release APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  NODE_VERSION: '18'
  EXPO_VERSION: 'latest'

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: |
        npm ci
        npm install -g eas-cli@${{ env.EXPO_VERSION }} expo@${{ env.EXPO_VERSION }}
        
    - name: Setup Expo and Configure EAS Project
      env:
        EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      run: |
        # æ˜¾ç¤ºå½“å‰ç›®å½•å’Œæ–‡ä»¶ç»“æ„ï¼ˆè°ƒè¯•ç”¨ï¼‰
        echo "å½“å‰ç›®å½•:"
        pwd
        echo "æ–‡ä»¶åˆ—è¡¨:"
        ls -la
        
        # æ£€æŸ¥æ˜¯å¦å·²é…ç½® EAS é¡¹ç›®
        echo "æ£€æŸ¥ app.json æ–‡ä»¶..."
        if [ -f "app.json" ]; then
          echo "app.json å†…å®¹:"
          cat app.json | head -20
          
          # æ£€æŸ¥ projectId
          if grep -q "projectId" app.json; then
            echo "âœ… é¡¹ç›®å·²æœ‰ EAS projectIdï¼Œè·³è¿‡åˆå§‹åŒ–ã€‚"
          else
            echo "ğŸ”„ é¡¹ç›®æ²¡æœ‰ EAS projectIdï¼Œæ­£åœ¨åˆå§‹åŒ–..."
            eas init --id --non-interactive
          fi
        else
          echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ° app.json æ–‡ä»¶"
          exit 1
        fi
        
    - name: Build Android APK
      env:
        EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      run: |
        echo "å¼€å§‹æ„å»º Android APK..."
        eas build --platform android --profile production --non-interactive
        
    - name: Upload APK as artifact
      uses: actions/upload-artifact@v4
      with:
        name: baby-feeding-tracker-apk
        path: ./baby-feeding-tracker.apk
        retention-days: 90
        
    - name: Create GitHub Release
      if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: ./baby-feeding-tracker.apk
        name: "å®å®å–‚å…»è®°å½• v1.0.0"
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
