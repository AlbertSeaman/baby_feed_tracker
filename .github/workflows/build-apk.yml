name: æ„å»º Android APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  NODE_VERSION: '18'

jobs:
  build-android:
    name: æ„å»º APK
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Node.js ç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        npm ci
        npm install -g eas-cli
        
    - name: é…ç½® Expo å’Œ EAS é¡¹ç›®
      env:
        EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      run: |
        echo "=== éªŒè¯ç¯å¢ƒ ==="
        # éªŒè¯ Token æœ‰æ•ˆ
        eas whoami
        
        echo "=== æ£€æŸ¥é¡¹ç›®é…ç½® ==="
        # ç¡®ä¿æœ‰å¿…è¦çš„é…ç½®æ–‡ä»¶
        if [ ! -f "app.json" ]; then
          echo "âŒ é”™è¯¯ï¼šç¼ºå°‘ app.json æ–‡ä»¶"
          exit 1
        fi
        
        # å¦‚æœæœ‰ eas.json åˆ™è·³è¿‡ï¼Œå¦åˆ™åˆ›å»ºåŸºç¡€é…ç½®
        if [ ! -f "eas.json" ]; then
          echo "åˆ›å»ºåŸºç¡€ EAS é…ç½®..."
          echo '{"cli":{"version":">=6.0.0","appVersionSource":"remote"},"build":{"production":{}}}' > eas.json
        fi
        
    - name: æäº¤äº‘ç«¯æ„å»ºä»»åŠ¡
      env:
        EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      run: |
        echo "=== æäº¤ Android æ„å»ºä»»åŠ¡åˆ° EAS ==="
        
        # æäº¤æ„å»ºï¼Œå¹¶ç­‰å¾…å®Œæˆï¼ˆ--wait å‚æ•°ï¼‰
        eas build --platform android --profile production --non-interactive --wait
        
        echo "âœ… æ„å»ºä»»åŠ¡å·²å®Œæˆï¼"
        
    - name: ä¸‹è½½å¹¶é‡å‘½å APK
      env:
        EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      run: |
        echo "=== ä¸‹è½½æ„å»ºå¥½çš„ APK ==="
        
        # æ–¹æ³•1ï¼šä½¿ç”¨æœ€æ–°çš„æ„å»ºIDä¸‹è½½
        echo "æŸ¥æ‰¾æœ€æ–°å®Œæˆçš„æ„å»º..."
        BUILD_JSON=$(eas build:list --platform android --status finished --limit 1 --json)
        
        if [ -z "$BUILD_JSON" ] || [ "$BUILD_JSON" = "[]" ]; then
          echo "âŒ æœªæ‰¾åˆ°å·²å®Œæˆçš„æ„å»º"
          echo "è¯·æ‰‹åŠ¨ä¸‹è½½ï¼šhttps://expo.dev/accounts/AlbertSeaman/projects/baby-feed-tracker/builds"
          exit 1
        fi
        
        # æå–æ„å»ºID
        BUILD_ID=$(echo "$BUILD_JSON" | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4)
        echo "æ‰¾åˆ°æ„å»º ID: $BUILD_ID"
        
        # ä¸‹è½½ APK
        eas build:download --id "$BUILD_ID" --output ./baby-feeding-tracker.apk
        
        # éªŒè¯æ–‡ä»¶å­˜åœ¨
        if [ -f "./baby-feeding-tracker.apk" ]; then
          echo "âœ… APK ä¸‹è½½æˆåŠŸï¼"
          ls -lh ./baby-feeding-tracker.apk
        else
          echo "âŒ æ–‡ä»¶ä¸‹è½½å¤±è´¥"
          exit 1
        fi
        
    - name: ä¸Šä¼  APK ä¾›ä¸‹è½½
      uses: actions/upload-artifact@v4
      with:
        name: baby-feeding-tracker-apk
        path: ./baby-feeding-tracker.apk  # ä¸ä¸‹è½½æ­¥éª¤çš„æ–‡ä»¶åä¸€è‡´
        retention-days: 90
        
    - name: æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
      run: |
        echo "ğŸ‰ æ„å»ºæµç¨‹å…¨éƒ¨å®Œæˆï¼"
        echo "ä¸‹è½½ APK æ–¹å¼ï¼š"
        echo "1. åœ¨æ­¤é¡µé¢åº•éƒ¨çš„ 'Artifacts' åŒºåŸŸä¸‹è½½"
        echo "2. æˆ–è®¿é—® Expo æ§åˆ¶å°ï¼šhttps://expo.dev/accounts/AlbertSeaman/projects/baby-feed-tracker/builds"
