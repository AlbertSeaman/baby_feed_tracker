name: æ„å»º Android APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  NODE_VERSION: '18'

jobs:
  build-android:
    name: æ„å»º APK
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Node.js ç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        npm ci
        npm install -g eas-cli
        
    - name: é…ç½® Expo å’Œ EAS é¡¹ç›®
      env:
        EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      run: |
        echo "=== éªŒè¯ç¯å¢ƒ ==="
        # éªŒè¯ Token æœ‰æ•ˆ
        eas whoami
        
        echo "=== æ£€æŸ¥é¡¹ç›®é…ç½® ==="
        # ç¡®ä¿æœ‰å¿…è¦çš„é…ç½®æ–‡ä»¶
        if [ ! -f "app.json" ]; then
          echo "âŒ é”™è¯¯ï¼šç¼ºå°‘ app.json æ–‡ä»¶"
          exit 1
        fi
        
        # å¦‚æœæœ‰ eas.json åˆ™è·³è¿‡ï¼Œå¦åˆ™åˆ›å»ºåŸºç¡€é…ç½®
        if [ ! -f "eas.json" ]; then
          echo "åˆ›å»ºåŸºç¡€ EAS é…ç½®..."
          echo '{"cli":{"version":">=6.0.0","appVersionSource":"remote"},"build":{"production":{}}}' > eas.json
        fi
        
    - name: æäº¤äº‘ç«¯æ„å»ºä»»åŠ¡å¹¶ç­‰å¾…å®Œæˆ
      env:
        EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      id: build-step  # ç»™è¿™ä¸ªæ­¥éª¤ä¸€ä¸ªIDï¼Œä¾¿äºåç»­å¼•ç”¨
      run: |
        echo "=== æäº¤ Android æ„å»ºä»»åŠ¡åˆ° EAS ==="
        
        # æäº¤æ„å»ºï¼Œå¹¶ç­‰å¾…å®Œæˆï¼ˆ--wait å‚æ•°ï¼‰
        # åŒæ—¶æ•è·è¾“å‡ºï¼Œæå–æ„å»ºID
        BUILD_OUTPUT=$(eas build --platform android --profile production --non-interactive --wait 2>&1)
        echo "$BUILD_OUTPUT"
        
        # ä»è¾“å‡ºä¸­æå–æ„å»ºIDï¼ˆç”¨äºåç»­ä¸‹è½½ï¼‰
        BUILD_ID=$(echo "$BUILD_OUTPUT" | grep -o "builds/[a-f0-9-]*" | head -1 | cut -d'/' -f2)
        if [ -n "$BUILD_ID" ]; then
          echo "æ„å»ºID: $BUILD_ID"
          echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
        fi
        
        # ä»è¾“å‡ºä¸­æå–ç›´æ¥ä¸‹è½½é“¾æ¥
        APK_URL=$(echo "$BUILD_OUTPUT" | grep -o "https://expo.dev/artifacts/eas/[^ ]*\.apk" | head -1)
        if [ -n "$APK_URL" ]; then
          echo "APKç›´æ¥ä¸‹è½½é“¾æ¥: $APK_URL"
          echo "apk_url=$APK_URL" >> $GITHUB_OUTPUT
        fi
        
        echo "âœ… æ„å»ºä»»åŠ¡å·²å®Œæˆï¼"
        
    - name: ä¸‹è½½ APK æ–‡ä»¶
      env:
        EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      run: |
        echo "=== ä¸‹è½½æ„å»ºå¥½çš„ APK ==="
        
        # æ–¹æ³•1ï¼šå¦‚æœæœ‰æ„å»ºIDï¼Œä½¿ç”¨æ„å»ºIDä¸‹è½½
        if [ -n "${{ steps.build-step.outputs.build_id }}" ]; then
          echo "ä½¿ç”¨æ„å»ºIDä¸‹è½½: ${{ steps.build-step.outputs.build_id }}"
          eas build:download --id "${{ steps.build-step.outputs.build_id }}" --output ./baby-feeding-tracker.apk
        fi
        
        # æ–¹æ³•2ï¼šå¦‚æœæ–¹æ³•1å¤±è´¥æˆ–æ²¡æœ‰æ„å»ºIDï¼Œæ£€æŸ¥æ˜¯å¦æœ‰ç›´æ¥ä¸‹è½½é“¾æ¥
        if [ ! -f "./baby-feeding-tracker.apk" ] && [ -n "${{ steps.build-step.outputs.apk_url }}" ]; then
          echo "ä½¿ç”¨ç›´æ¥é“¾æ¥ä¸‹è½½..."
          curl -L "${{ steps.build-step.outputs.apk_url }}" -o ./baby-feeding-tracker.apk
        fi
        
        # éªŒè¯æ–‡ä»¶å­˜åœ¨
        if [ -f "./baby-feeding-tracker.apk" ]; then
          echo "âœ… APK ä¸‹è½½æˆåŠŸï¼æ–‡ä»¶å¤§å°:"
          ls -lh ./baby-feeding-tracker.apk
        else
          echo "âš ï¸  æ— æ³•è‡ªåŠ¨ä¸‹è½½APK"
          echo "è¯·æ‰‹åŠ¨ä»ä»¥ä¸‹é“¾æ¥ä¸‹è½½ï¼š"
          echo "${{ steps.build-step.outputs.apk_url }}"
          echo "æˆ–è®¿é—®ï¼šhttps://expo.dev/accounts/AlbertSeaman/projects/baby-feed-tracker/builds"
        fi
        
    - name: ä¸Šä¼  APK ä¾›ä¸‹è½½
      if: success() && hashFiles('./baby-feeding-tracker.apk') == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: baby-feeding-tracker-apk
        path: ./baby-feeding-tracker.apk
        retention-days: 90
        
    - name: æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
      if: always()
      run: |
        echo "=== æ„å»ºç»“æœ ==="
        if [ "${{ job.status }}" = "success" ]; then
          echo "ğŸ‰ æ„å»ºæµç¨‹å®Œæˆï¼"
          echo ""
          echo "ä¸‹è½½ APK æ–¹å¼ï¼š"
          echo "1. åœ¨æ­¤é¡µé¢åº•éƒ¨çš„ 'Artifacts' åŒºåŸŸä¸‹è½½"
          echo "2. ç›´æ¥é“¾æ¥ï¼š${{ steps.build-step.outputs.apk_url }}"
          echo "3. Expo æ§åˆ¶å°ï¼šhttps://expo.dev/accounts/AlbertSeaman/projects/baby-feed-tracker/builds"
        else
          echo "âš ï¸  æ„å»ºè¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜"
          echo "è¯·æ£€æŸ¥é”™è¯¯æ—¥å¿—å¹¶é‡è¯•"
        fi
